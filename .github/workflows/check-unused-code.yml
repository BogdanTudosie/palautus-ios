name: Check Unused Code

on:
    pull_request:
      branches: [ main ]
    push:
      branches: [ main ]
jobs:
    periphery:
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v4

        - name: Select Xcode
          run: sudo xcode-select -s /Applications/Xcode_16.2.app

        - name: Install periphery
          run: brew install periphery

        - name: Build for indexing
          run: |
            xcodebuild clean build \
            -project palautus.xcodeproj \
            -scheme palautus \
            -destination "platform=iOS Simulator,name=iPhone 15 Pro" \
            -sdk iphonesimulator \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=YES \
            | xcpretty && exit ${PIPESTATUS[0]

        - name: Run periphery
          run: |
            mkdir -p periphery-reports
            periphery scan --project palautus.xcodeproj --schemes palautus --format json --skip-build > periphery-reports/report.json

        - name: Upload Periphery Reports
          uses: actions/upload-artifact@v4
          with:
            name: periphery-scan-results
            path: periphery-reports
            retention-days: 30