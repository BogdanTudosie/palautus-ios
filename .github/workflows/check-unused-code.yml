name: Check Unused Code

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
    periphery:
      runs-on: macos-latest
      steps:
        - uses: actions/checkout@v4

        - name: Select Xcode
          run: sudo xcode-select -s /Applications/Xcode_16.2.app

        - name: Download iOS 18.2 Platform
          run: |
            echo "Downloading iOS platform..."
            xcrun xcodebuild -downloadPlatform iOS
            
            echo "Waiting for download to complete..."
            sleep 30
            
            echo "\nAvailable runtimes after download:"
            xcrun simctl list runtimes
  
        - name: Create and Boot Simulator
          run: |
            SIMULATOR_NAME="iPhone 14"
            
            # Use iOS 18.3 runtime
            RUNTIME_ID="com.apple.CoreSimulator.SimRuntime.iOS-18-3-1"
            echo "Using runtime: ${RUNTIME_ID}"
            
            SIMULATOR_UDID=$(xcrun simctl create "${SIMULATOR_NAME}" "iPhone 14" "${RUNTIME_ID}")
            echo "Created simulator: ${SIMULATOR_UDID}"
            
            xcrun simctl boot "${SIMULATOR_UDID}"
            echo "SIMULATOR_UDID=${SIMULATOR_UDID}" >> $GITHUB_ENV

        - name: Install periphery
          run: brew install periphery

        - name: Build for indexing
          run: |
            xcodebuild clean build \
            -project palautus.xcodeproj \
            -scheme palautus \
            -destination "platform=iOS Simulator,name=iPhone 15 Pro" \
            -sdk iphonesimulator \
            CODE_SIGNING_REQUIRED=NO \
            ONLY_ACTIVE_ARCH=YES \
            | xcpretty && exit ${PIPESTATUS[0]

        - name: Run periphery
          run: |
            mkdir -p periphery-reports
            periphery scan --project palautus.xcodeproj --schemes palautus --format json --skip-build > periphery-reports/report.json

        - name: Upload Periphery Reports
          uses: actions/upload-artifact@v4
          with:
            name: periphery-scan-results
            path: periphery-reports
            retention-days: 30
