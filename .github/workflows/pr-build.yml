name: iOS Pull Request
on:
  pull_request:
    branches: [develop, feature-branch, main]
    paths:
      - "**.swift"
      - "**.xcodeproj/**"
      - "**.plist"
      - ".github/workflows/**"

jobs:
  build-and-test:
    name: ðŸ“± Build and Test
    runs-on: macos-latest
    permissions:
      contents: read
      security-events: write

    outputs:
      test-status: ${{ steps.tests.outputs.status }}
      coverage: ${{ steps.coverage.outputs.percentage }}

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Select Xcode Version
        run: |
          echo "Using Xcode 16.2..."
          sudo xcode-select -s /Applications/Xcode_16.2.app
          xcodebuild -version

      - name: ðŸ“± Setup iOS Simulator
        id: simulator
        run: |
          echo "Setting up iOS Simulator..."
          # Download iOS platform with retry
          for i in {1..5}; do
            xcrun xcodebuild -downloadPlatform iOS && break
            echo "âš ï¸ Attempt $i failed. Retrying..."
            sleep 10
          done

          # Find and setup simulator
          SIMULATOR_UDID=$(xcrun simctl list devices | awk '/iOS 18\./{flag=1;next}/^--/{flag=0}flag' | grep 'iPhone 16' | grep -v 'unavailable' | awk -F '[()]' '{print $2}' | head -n 1)
          echo "SIMULATOR_UDID=${SIMULATOR_UDID}" >> $GITHUB_OUTPUT
          xcrun simctl erase "$SIMULATOR_UDID"

          echo "ðŸš€ Booting simulator..."
          xcrun simctl boot "$SIMULATOR_UDID"

          # Wait for boot
          for i in {1..12}; do
            if xcrun simctl list devices | grep "$SIMULATOR_UDID" | grep -q "Booted"; then
              echo "âœ… Simulator booted successfully"
              break
            fi
            echo "â³ Waiting for simulator to boot (attempt $i/12)..."
            sleep 5
          done

      - name: ðŸ’¾ Cache Build Data
        uses: actions/cache@v3
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
          restore-keys: ${{ runner.os }}-xcode-

      - name: ðŸ—ï¸ Build and Test
        id: tests
        run: |
          echo "ðŸš€ Starting build and test..."

          # Create test output directory
          mkdir -p test-results

          # Run build and tests
          xcodebuild test \
          -project palautus.xcodeproj \
          -scheme palautus \
          -destination "platform=iOS Simulator,id=${{ steps.simulator.outputs.SIMULATOR_UDID }}" \
          -sdk iphonesimulator \
          -enableCodeCoverage YES \
          -parallel-testing-enabled YES \
          -maximum-parallel-testing-workers 3 \
          -derivedDataPath ~/Library/Developer/Xcode/DerivedData \
          -configuration Debug \
          -resultBundlePath "./test-results/TestResults.xcresult" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=YES \
          IPHONEOS_DEPLOYMENT_TARGET=16.0 \
          | tee xcodebuild.log \
          | xcpretty --color --simple

          # Extract test results
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Tests passed successfully"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Tests failed. Check logs for details."
            exit 1
          fi

      - name: ðŸ“Š Calculate Code Coverage
        id: coverage
        if: success()
        run: |
          COVERAGE=$(xcrun xccov view test-results/TestResults.xcresult | grep -E '^Total$' | awk '{print $3}')
          echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Code Coverage: ${COVERAGE}%"

      - name: ðŸ“¦ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            xcodebuild.log
          retention-days: 14

  lint:
    name:  Lint
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: norio-nomura/action-swiftlint@3.2.1
        with:
          args: --strict

  security:
    name: Security Scan
    needs: build-and-test
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
